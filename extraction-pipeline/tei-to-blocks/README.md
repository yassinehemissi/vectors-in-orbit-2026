# tei-to-blocks

Convert TEI XML into structured "blocks" suitable for downstream indexing, retrieval, or chunked processing. This utility is used to convert the TEI generated by GROBID from scientific papers (PDF) into blocks digestible by the LLM experiments extraction pipeline and storage.

## What it does

- Parses TEI XML with `lxml` and walks the document structure.
- Emits blocks for titles, section headings, paragraphs, abstracts, back matter, figure captions, tables, and equations.
- Splits long text into sentence-based chunks with stable, deterministic block IDs.
- Promotes table-like paragraphs into markdown tables when they pass heuristics.

## Output shape

Each block is a JSON object with:

- `block_id`: Stable SHA-256 derived ID (prefix `b_`).
- `type`: Block type (see below).
- `section_path`: List of section headings leading to the block.
- `text`: Normalized text.
- `source`: Source metadata such as `tei_xpath`, optional `xml_id`, and other extras.
- `chunk`: Optional chunk info `{ "index": n, "total": m }` when text is split.

## Block types

Common types emitted by the converter:

- `title`
- `abstract`
- `section_title`
- `paragraph`
- `figure_caption`
- `table_label`
- `table_body`
- `equation`
- `back_matter`

## Usage

```python
from tei_to_blocks import tei_to_blocks_json

tei_xml = open("paper.xml", "r", encoding="utf-8").read()
blocks = tei_to_blocks_json(
    tei_xml,
    include_front=True,
    include_back=False,
    max_block_chars=1200,
)

# blocks is a list of dicts
```

For more control:

```python
from tei_to_blocks import TEIToBlocks, ConverterConfig

cfg = ConverterConfig(
    include_front=True,
    include_back=False,
)
converter = TEIToBlocks(config=cfg)
blocks = converter.tei_to_blocks_json(tei_xml)
```

## Configuration

`ConverterConfig` exposes:

- `include_front`: Include front matter (title, abstract).
- `include_back`: Include back matter.
- `chunking`: `max_chars`, `max_sentences` for chunking text.
- `tables`: Heuristics for detecting table-like paragraphs.
- `figures`: Heuristics for detecting figure captions.

See `config.py` for defaults.

## Table handling

- TEI `<table>` nodes are rendered to markdown.
- Paragraphs that resemble tables are promoted to `table_body` blocks.
- Table references like "Table 3" are emitted as `table_label` blocks when detected.

## Figure captions

Figure captions are detected from:

- `<figure><figDesc>...</figDesc></figure>`
- Paragraphs starting with "Figure 1:" or similar patterns.

## Dependencies

- `lxml`
- `pandas`
- `spacy` (uses a blank English pipeline with a sentencizer)

## Notes

- TEI parsing uses strict XML parsing; invalid XML raises `ValueError`.
- Block IDs are stable across runs for identical inputs.
